rule strongpity_malware {
    meta:
        id = "f19a685c-599d-42cf-a5d8-7a2375102f97"
        version = "1.0"
        description = "Detects obfuscation used by StrongPity"
        author = "Sekoia.io"
        creation_date = "2024-02-26"
        classification = "TLP:CLEAR"
        
    strings:
        /*
        Detects things like :
        v14= rand() % 8 + 2;
        */
        $rand_edi = {E8 ?? ?? ?? ??    8B F8 81 E7 07 00 00 80    79 ?? 4F 83 CF F8 47 83 C7 02}
        $rand_esi = {E8 ?? ?? ?? ?? 8B F0 81 E6 07 00 00 80 79 ?? 4E 83 CE F8 46 83 C6 02}
        $rand_eax = {E8 ?? ?? ?? ??    25 07 00 00 80 79 ?? 48 83 C8 F8 40 83 C0 02}
        
    condition:
        uint16be(0) == 0x4d5a and #rand_edi + #rand_esi + #rand_eax>20
}
        