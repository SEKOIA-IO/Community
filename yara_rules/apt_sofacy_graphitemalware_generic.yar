import "pe"
        
rule apt_sofacy_graphitemalware_generic {
    meta:
        id = "6b51cfa3-4a7d-4c2a-9fd9-f129b8a18466"
        version = "1.0"
        description = "Detects APT28 graphite malware based on strings"
        author = "Sekoia.io"
        creation_date = "2022-09-27"
        classification = "TLP:CLEAR"
        
    strings:
        $ = "Microsoft Enhanced RSA and AES Cryptographic Provider" wide
        $ = "Microsoft Enhanced RSA and AES Cryptographic Provider (Prototype)" wide
        $ = "%s %04d sp%1d.%1d %s"
        $ = "%s%c%s%c%s"
        $ = "InternetReadFile"
        $ = "ObtainUserAgentString"
        $ = "CryptImportKey"
        
    condition:
        uint16be(0) == 0x4d5a and 
        filesize < 100KB   and
        ( all of them or pe.imphash() == "c56c322548250651361aef7dacf93eaf" )
}
        